#cloud-config

# Application Tier VM Configuration
# Purpose: Node.js API server for task management

package_update: true
package_upgrade: true

# Install packages
packages:
  - curl
  - git
  - htop
  - net-tools
  - vim
  - build-essential  # For npm native modules

# Create application directory structure
write_files:
  - path: /etc/profile.d/node-env.sh
    content: |
      # Node.js environment variables
      export NODE_ENV=production
      export PORT=8080
    permissions: '0644'

  - path: /home/azureuser/app/.gitkeep
    content: |
      # Application will be deployed here
    owner: azureuser:azureuser
    permissions: '0644'

  - path: /etc/motd
    content: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                                                          â•‘
      â•‘              ðŸš€ APPLICATION TIER VM                     â•‘
      â•‘                                                          â•‘
      â•‘  Purpose: Node.js API Server                             â•‘
      â•‘  Subnet: App (10.0.2.0/24)                               â•‘
      â•‘  Access: Via bastion only                                â•‘
      â•‘                                                          â•‘
      â•‘  Application Directory: /home/azureuser/app              â•‘
      â•‘  Logs: /home/azureuser/app/logs                          â•‘
      â•‘  Port: 8080                                              â•‘
      â•‘                                                          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    permissions: '0644'

# Run commands after packages are installed
runcmd:
  # Install Node.js 18 LTS
  - curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
  - apt-get install -y nodejs
  
  # Verify Node.js installation
  - node --version > /var/log/nodejs-version.log
  - npm --version >> /var/log/nodejs-version.log
  
  # Create application directories
  - mkdir -p /home/azureuser/app/logs
  - chown -R azureuser:azureuser /home/azureuser/app
  
  # Install PM2 (process manager for Node.js)
  - npm install -g pm2
  
  # Configure PM2 to start on boot
  - sudo -u azureuser pm2 startup systemd -u azureuser --hp /home/azureuser
  - env PATH=$PATH:/usr/bin pm2 startup systemd -u azureuser --hp /home/azureuser
  
  # Create a test file to verify setup
  - |
    cat > /home/azureuser/app/test-server.js << 'EOF'
    // Simple test server
    const http = require('http');
    const port = 8080;
    
    const server = http.createServer((req, res) => {
      res.writeHead(200, {'Content-Type': 'text/plain'});
      res.end('App Tier VM is working! Node.js ' + process.version + '\n');
    });
    
    server.listen(port, '0.0.0.0', () => {
      console.log(`Test server running on port ${port}`);
    });
    EOF
  
  - chown azureuser:azureuser /home/azureuser/app/test-server.js
  
  # Log completion
  - echo "App VM setup completed at $(date)" >> /var/log/app-vm-setup.log
  - echo "Node.js version: $(node --version)" >> /var/log/app-vm-setup.log
  - echo "NPM version: $(npm --version)" >> /var/log/app-vm-setup.log
  - echo "PM2 installed: $(pm2 --version)" >> /var/log/app-vm-setup.log

final_message: "Application tier VM ready for Node.js deployment"