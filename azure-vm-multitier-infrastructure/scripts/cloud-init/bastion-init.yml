#cloud-config

# Bastion host configuration
# Purpose: Secure SSH jump host for administrative access

package_update: true
package_upgrade: true

# Install useful tools for bastion host
packages:
  - htop
  - net-tools
  - curl
  - vim
  - tmux
  - ncdu

# Configure SSH for jump host
write_files:
  - path: /etc/ssh/sshd_config.d/bastion.conf
    content: |
      # Bastion SSH hardening
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      X11Forwarding no
      MaxAuthTries 3
      MaxSessions 5
      ClientAliveInterval 300
      ClientAliveCountMax 2
    permissions: '0644'

  - path: /etc/motd
    content: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                                                          â•‘
      â•‘       ğŸ”’ BASTION HOST - AUTHORIZED ACCESS ONLY           â•‘
      â•‘                                                          â•‘
      â•‘  This is a jump host for accessing internal VMs          â•‘
      â•‘  All activities are logged and monitored                 â•‘
      â•‘                                                          â•‘
      â•‘  Available subnets:                                      â•‘
      â•‘    - Web:  10.0.1.0/24                                   â•‘
      â•‘    - App:  10.0.2.0/24                                   â•‘
      â•‘    - Data: 10.0.3.0/24                                   â•‘
      â•‘                                                          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    permissions: '0644'

# Run commands after packages are installed
runcmd:
  - mkdir -p /home/azureuser/.ssh
  - chown azureuser:azureuser /home/azureuser/.ssh
  - chmod 700 /home/azureuser/.ssh
  - |
    cat <<'EOF' > /home/azureuser/.ssh/config
    # SSH client config for jump host
    Host web-*
      StrictHostKeyChecking no
      UserKnownHostsFile /dev/null
      User azureuser

    Host app-*
      StrictHostKeyChecking no
      UserKnownHostsFile /dev/null
      User azureuser

    Host data-*
      StrictHostKeyChecking no
      UserKnownHostsFile /dev/null
      User azureuser
    EOF
  - chown azureuser:azureuser /home/azureuser/.ssh/config
  - chmod 600 /home/azureuser/.ssh/config
  
  # Log completion
  - echo "Bastion host setup completed at $(date)" >> /var/log/bastion-setup.log

final_message: "Bastion host ready for jump host operations"